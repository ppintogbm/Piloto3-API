pipeline{
	agent {
		kubernetes{
			cloud "${cloudName}"
			label "backend-build"
			yamlFile "cicd/${buildPodFile}"
		}
  }
	parameters{
		string(name: "cloudName", description: "Cloud Name.")
		string(name: "buildPodFile", description: "Build Pod yaml file name.")
		string(name: "imageRepository", description: "Container image repository")
	}
	stages{
		stage('Prepare'){
			steps{
				script{
					tag = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
				}
			}
		}
		stage('Build Bars'){
			steps{
				container('ace'){
					sh "bash -c 'mqsipackagebar -a compiled.bar -w . -k ApiCalculadora'"
				}
			}
   	}
		stage('Build Image'){
			environment{
				PATH="/busybox:/kaniko:$PATH"
				DESTINATION="${imageRepository}:${tag}"
			}
			steps{
				container('kaniko'){
					sh '''#!/busybox/sh
								echo "Building $DESTINATION"
								executor --dockerfile=Dockerfile --context="." --destination=$DESTINATION
						 '''
				}
			}
		}
	}
}
